name: Approve or Reject Plugin

on:
  issue_comment:
    types: [created]

jobs:
  approve:
    if: >-
      contains(github.event.issue.labels.*.name, 'plugin-submission') &&
      contains(github.event.issue.labels.*.name, 'validated') &&
      contains(github.event.comment.body, '/approve')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Check maintainer permission
        id: check-permission
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: commenter
            });
            
            const allowedPermissions = ['admin', 'write'];
            if (!allowedPermissions.includes(permission.permission)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ @${commenter} åªæœ‰ **ä»“åº“ç»´æŠ¤è€…** (admin/write) å¯ä»¥ä½¿ç”¨ \`/approve\` å‘½ä»¤ã€‚`
              });
              core.setFailed(`ç”¨æˆ· @${commenter} æ²¡æœ‰æƒé™æ‰¹å‡†æ’ä»¶`);
              return;
            }
            
            console.log(`âœ… @${commenter} (${permission.permission}) æ‰§è¡Œ /approve`);
            core.setOutput('approved_by', commenter);

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse issue and add plugin
        id: add-plugin
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const body = context.payload.issue.body;
            const pluginIdMatch = body.match(/### æ’ä»¶ ID \/ Plugin ID\s*\n\s*\n(.+)/);
            const repoUrlMatch = body.match(/### ä»“åº“åœ°å€ \/ Repository URL\s*\n\s*\n(.+)/);
            
            if (!pluginIdMatch || !repoUrlMatch) {
              core.setFailed('æ— æ³•è§£æ Issue å†…å®¹');
              return;
            }
            
            const pluginId = pluginIdMatch[1].trim();
            const repoUrl = repoUrlMatch[1].trim();
            
            const plugins = JSON.parse(fs.readFileSync('plugins.json', 'utf8'));
            
            if (plugins.some(p => p.id === pluginId)) {
              core.setFailed(`æ’ä»¶ ID å·²å­˜åœ¨: ${pluginId}`);
              return;
            }
            if (plugins.some(p => p.repositoryUrl === repoUrl)) {
              core.setFailed(`ä»“åº“ URL å·²å­˜åœ¨: ${repoUrl}`);
              return;
            }
            
            plugins.push({
              id: pluginId,
              repositoryUrl: repoUrl
            });
            
            fs.writeFileSync('plugins.json', JSON.stringify(plugins, null, 2) + '\n');
            
            core.setOutput('plugin_id', pluginId);
            core.setOutput('repo_url', repoUrl);

      - name: Commit and push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add plugins.json
          git commit -m "feat: Add ${{ steps.add-plugin.outputs.plugin_id }} plugin (via #${{ github.event.issue.number }})"
          git push

      - name: Close issue with success
        uses: actions/github-script@v7
        with:
          script: |
            const pluginId = '${{ steps.add-plugin.outputs.plugin_id }}';
            const approvedBy = '${{ steps.check-permission.outputs.approved_by }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ‰ æ’ä»¶å·²æ·»åŠ  / Plugin Added\n\næ’ä»¶ \`${pluginId}\` å·²æˆåŠŸæ·»åŠ åˆ°æ’ä»¶ä¸­å¿ƒï¼\n\n| ä¿¡æ¯ | å€¼ |\n|------|----|\n| æ‰¹å‡†äºº | @${approvedBy} |\n| å…³è” Issue | #${context.issue.number} |\n\næ’ä»¶è¯¦æƒ…å°†åœ¨ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°åæ˜¾ç¤ºåœ¨ [æ’ä»¶å±•ç¤ºé¡µ](https://plugins.maibot.chat/)\n\næ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ / Thank you for your contribution!`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['approved']
            });
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });

      - name: Handle approve failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ æ·»åŠ å¤±è´¥ / Addition Failed\n\næ’ä»¶æ·»åŠ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚\n\nè¯·æ£€æŸ¥ [å·¥ä½œæµæ—¥å¿—](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) è·å–è¯¦ç»†ä¿¡æ¯ã€‚`
            });

  reject:
    if: >-
      contains(github.event.issue.labels.*.name, 'plugin-submission') &&
      startsWith(github.event.comment.body, '/reject')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Check maintainer permission and reject
        uses: actions/github-script@v7
        with:
          script: |
            const commenter = context.payload.comment.user.login;
            const commentBody = context.payload.comment.body;
            
            // æ£€æŸ¥æƒé™
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: commenter
            });
            
            const allowedPermissions = ['admin', 'write'];
            if (!allowedPermissions.includes(permission.permission)) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ @${commenter} åªæœ‰ **ä»“åº“ç»´æŠ¤è€…** (admin/write) å¯ä»¥ä½¿ç”¨ \`/reject\` å‘½ä»¤ã€‚`
              });
              core.setFailed(`ç”¨æˆ· @${commenter} æ²¡æœ‰æƒé™æ‹’ç»æ’ä»¶`);
              return;
            }
            
            // è§£ææ‹’ç»åŸå› 
            const reasonMatch = commentBody.match(/^\/reject\s*([\s\S]*)/);
            let reason = reasonMatch && reasonMatch[1].trim();
            
            if (!reason) {
              reason = 'æœªæä¾›å…·ä½“åŸå› ';
            }
            
            console.log(`@${commenter} æ‹’ç»æ’ä»¶ï¼ŒåŸå› : ${reason}`);
            
            // æ·»åŠ æ‹’ç»è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸš« æ’ä»¶è¢«æ‹’ç» / Plugin Rejected\n\næ­¤æ’ä»¶æäº¤å·²è¢«ç»´æŠ¤è€…æ‹’ç»ã€‚\n\n| ä¿¡æ¯ | å€¼ |\n|------|----|\n| æ‹’ç»äºº | @${commenter} |\n| åŸå›  | ${reason} |\n\nå¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»ä»“åº“ç»´æŠ¤è€…ã€‚\n\n---\n\n*å¦‚æœæ‚¨å·²ä¿®æ”¹æ’ä»¶ä»¥ç¬¦åˆè¦æ±‚ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„ Issue é‡æ–°æäº¤ã€‚*`
            });
            
            // ç§»é™¤éªŒè¯ç›¸å…³æ ‡ç­¾ï¼Œæ·»åŠ  rejected æ ‡ç­¾
            const labelsToRemove = ['validated', 'validation-failed', 'pending-validation'];
            for (const label of labelsToRemove) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              } catch (e) {
                // æ ‡ç­¾ä¸å­˜åœ¨ï¼Œå¿½ç•¥
              }
            }
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['rejected']
            });
            
            // å…³é—­ Issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
